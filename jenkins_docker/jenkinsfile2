pipeline {
    agent any

    environment {
        // Initialize the initial version tag
        versionTag = '1.0'
        previousTag = ''
        repositoryName = 'alpaca-flask'
        dockerHubUsername = 'noaavisrur'
        newTag = ''
        currentTag = ''
    }

    stages {
        stage('Clean up & clone') {
            steps {
                sh 'sudo rm -rf $WORKSPACE/*'
                sh 'sudo rm -rf $WORKSPACE/.*'
                sh 'sudo git clone https://github.com/noaavisrur/alpaca-flask.git'
            }
        }

        stage('Set version tag') {
            steps {
                script {
                    def currentTag = versionTag.toFloat()
                    def newTag = currentTag + 0.1
                    previousTag = versionTag // Store the previous version tag
                    versionTag = newTag.toString()
                }
            }
        }

        stage('Build and Push Docker Image') {
            steps {
                // Use the updated version tag in the Docker build command
                sh "cd /home/noa/flask_proj/flask/alpaca-flask && sudo docker build -t ${dockerHubUsername}/${repositoryName}:${versionTag} ."
                // Delete the previous version of the Docker image
                sh "docker rmi ${dockerHubUsername}/${repositoryName}:${previousTag}"
            }
        }

        stage('Delete repository from Docker Hub') {
            steps {
                withCredentials([string(credentialsId: 'docker-hub_cre', variable: 'docker_access_key')]) {
                    sh "docker logout"
                    sh "docker login --username ${dockerHubUsername} --password $docker_access_key"
                    sh "docker rmi ${dockerHubUsername}/${repositoryName}"
                }
            }
        }
    }
}
